import test from "node:test";
import assert from "node:assert/strict";
import {
  computePortSweepScore,
  computeNetworkRelinkScore,
  computeRewardMultiplier,
  hasMinigameRewardEligibility,
  shouldResetHeatAfterMinigame,
} from "../services/minigame.js";

test("port_sweep score is zero when no probes were used", () => {
  const score = computePortSweepScore(0, 5, 0, 18);
  assert.equal(score, 0);
});

test("low-score multiplier does not reward zero-play outcomes", () => {
  assert.equal(computeRewardMultiplier(0), 0);
  assert.ok(computeRewardMultiplier(10) < 0.08);
  assert.ok(computeRewardMultiplier(30) < 0.25);
  assert.equal(computeRewardMultiplier(50), 0.7);
  assert.equal(computeRewardMultiplier(100), 1.25);
});

test("minigame reward eligibility requires at least one move", () => {
  assert.equal(hasMinigameRewardEligibility("signal_crack", 0), false);
  assert.equal(hasMinigameRewardEligibility("port_sweep", 0), false);
  assert.equal(hasMinigameRewardEligibility("network_relink", 0), false);
  assert.equal(hasMinigameRewardEligibility("signal_crack", 1), true);
  assert.equal(hasMinigameRewardEligibility("network_relink", 1), true);
});

test("heat resets only on successful undetected outcomes", () => {
  assert.equal(shouldResetHeatAfterMinigame(49, false), false);
  assert.equal(shouldResetHeatAfterMinigame(50, true), false);
  assert.equal(shouldResetHeatAfterMinigame(50, false), true);
  assert.equal(shouldResetHeatAfterMinigame(90, false), true);
});

// Network Relink scoring tests
test("network_relink perfect solve scores 100", () => {
  // All pairs connected + full coverage = 60 + 40 = 100
  assert.equal(computeNetworkRelinkScore(4, 4, 25, 25), 100);
});

test("network_relink partial pairs + full coverage", () => {
  // 2/4 pairs connected (30) + 25/25 coverage (40) = 70
  assert.equal(computeNetworkRelinkScore(2, 4, 25, 25), 70);
});

test("network_relink all pairs + partial coverage", () => {
  // 4/4 pairs (60) + 15/25 coverage (24) = 84
  assert.equal(computeNetworkRelinkScore(4, 4, 15, 25), 84);
});

test("network_relink zero submission scores 0", () => {
  assert.equal(computeNetworkRelinkScore(0, 4, 0, 25), 0);
});
