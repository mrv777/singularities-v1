import test from "node:test";
import assert from "node:assert/strict";
import {
  computePortSweepScore,
  computeNetworkRelinkScore,
  computeRewardMultiplier,
  hasMinigameRewardEligibility,
  shouldResetHeatAfterMinigame,
} from "../services/minigame.js";

test("port_sweep score is zero when no probes were used", () => {
  const score = computePortSweepScore(0, 5, 0, 18);
  assert.equal(score, 0);
});

test("low-score multiplier does not reward zero-play outcomes", () => {
  assert.equal(computeRewardMultiplier(0), 0);
  assert.ok(computeRewardMultiplier(10) < 0.08);
  assert.ok(computeRewardMultiplier(30) < 0.25);
  assert.equal(computeRewardMultiplier(50), 0.7);
  assert.equal(computeRewardMultiplier(100), 1.25);
});

test("minigame reward eligibility requires at least one move", () => {
  assert.equal(hasMinigameRewardEligibility("signal_crack", 0), false);
  assert.equal(hasMinigameRewardEligibility("port_sweep", 0), false);
  assert.equal(hasMinigameRewardEligibility("network_relink", 0), false);
  assert.equal(hasMinigameRewardEligibility("signal_crack", 1), true);
  assert.equal(hasMinigameRewardEligibility("network_relink", 1), true);
});

test("heat resets only on successful undetected outcomes", () => {
  assert.equal(shouldResetHeatAfterMinigame(49, false), false);
  assert.equal(shouldResetHeatAfterMinigame(50, true), false);
  assert.equal(shouldResetHeatAfterMinigame(50, false), true);
  assert.equal(shouldResetHeatAfterMinigame(90, false), true);
});

// Network Relink scoring tests
// graceMs = totalPairs * 5000; within grace period timeEfficiency = 1.0
test("network_relink perfect solve within grace scores 100", () => {
  // elapsedMs=0 < graceMs=20000 → timeEfficiency=1.0 → 60 + 40 = 100
  assert.equal(computeNetworkRelinkScore(4, 4, 25, 25, 0, 120_000), 100);
});

test("network_relink partial pairs + full coverage within grace", () => {
  // 2/4 pairs (30) + 25/25 coverage * 1.0 (40) = 70
  assert.equal(computeNetworkRelinkScore(2, 4, 25, 25, 0, 120_000), 70);
});

test("network_relink all pairs + partial coverage within grace", () => {
  // 4/4 pairs (60) + 15/25 coverage * 1.0 (24) = 84
  assert.equal(computeNetworkRelinkScore(4, 4, 15, 25, 0, 120_000), 84);
});

test("network_relink zero submission scores 0", () => {
  assert.equal(computeNetworkRelinkScore(0, 4, 0, 25, 0, 120_000), 0);
});

test("network_relink slow solve decays coverage bonus", () => {
  // 4 pairs, graceMs=8000, timeLimitMs=120000, elapsedMs=64000
  // timeEfficiency = 1 - (64000-8000)/(120000-8000) = 1 - 56000/112000 = 0.5
  // score = 60 + (25/25)*0.5*40 = 60 + 20 = 80
  assert.equal(computeNetworkRelinkScore(4, 4, 25, 25, 64_000, 120_000), 80);
});

test("network_relink max-time solve zeroes coverage bonus", () => {
  // elapsedMs >= timeLimitMs → timeEfficiency=0 → score = 60 + 0 = 60
  assert.equal(computeNetworkRelinkScore(4, 4, 25, 25, 120_000, 120_000), 60);
});
